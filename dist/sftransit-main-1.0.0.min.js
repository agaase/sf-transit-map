/*! sftransit.js - v1.0.0 - 2017-03-01
* https://github.com/agaase/
* Copyright (c) 2017 agaase; Licensed MIT */
var MapRender=function(){var a,b,c,d={},e={},f=[],g=function(){var a=parseInt(d3.select("#map").style("width")),b=window.innerHeight,d=d3.tile().size([a,window.innerHeight]),e=d3.geoMercator().center([-122.4335457,37.7800564]).scale(22e4),f=d3.zoom().scaleExtent([1,2]).on("zoom",function(){c.style("transform","translate("+d3.event.transform.x+"px,"+d3.event.transform.y+"px) scale("+d3.event.transform.k+")")}),g=d3.geoPath().projection(e);c=d3.select("#map").append("svg").attr("width","100%").attr("height",b).call(f);var h=c.append("g").attr("class","baseMap").on("click",function(){l()});return h.selectAll("g").data(d.scale(2*e.scale()*Math.PI).translate(e([0,0]))).enter().append("g").each(function(a){var b=d3.select(this);d3.json("https://tile.mapzen.com/mapzen/vector/v1/roads/"+a[2]+"/"+a[0]+"/"+a[1]+".json?api_key=odes-9thVtDE",function(a,c){if(a)throw a;b.selectAll("path").data(c.features.sort(function(a,b){return a.properties.sort_key-b.properties.sort_key})).enter().append("path").attr("class",function(a){return a.properties.kind}).attr("d",g)})}),{mapProjection:e}}(),h=function(a,b){localStorage.getItem(a),d3.xml("http://webservices.nextbus.com/service/publicXMLFeed?command=routeConfig&a=sf-muni&r="+a,function(c,d){var e=[].map.call(d.querySelectorAll("path"),function(a){var b=[].map.call(a.querySelectorAll("point"),function(a){return g.mapProjection([parseFloat(a.getAttribute("lon")),parseFloat(a.getAttribute("lat"))])});return b}),f={};[].map.call(d.querySelectorAll("stop"),function(a){a.getAttribute("lon")&&(f[a.getAttribute("tag")]=[parseFloat(a.getAttribute("lon")),parseFloat(a.getAttribute("lat"))])});var h={};[].map.call(d.querySelectorAll("direction"),function(a){var b=a.getAttribute("tag").indexOf("_I_")>-1?"I":"O";h[b]={title:a.getAttribute("title")};var c=[].map.call(a.querySelectorAll("stop"),function(a){return f[a.getAttribute("tag")]});h[b].stops=c});var i;[].map.call(d.querySelectorAll("route"),function(a){i=a.getAttribute("title")});var j={pathPoints:e,directions:h,name:i};localStorage.setItem(a,JSON.stringify(j)),b(j)})},i=function(a){var b;b=d3.select(".vehicleMarkers").empty()?c.append("g").attr("class","vehicleMarkers"):d3.select(".vehicleMarkers");for(var d in a){var h=a[d];if(f.indexOf(h.route)>-1||!f.length){var i=h.coord,j=g.mapProjection(i),l=b.append("svg:image").attr("xlink:href","images/bus-icons/bus.png").attr("x",j[0]).attr("y",j[1]).attr("class","vehicleMarker").attr("width","16.8").attr("height","6").attr("transform-origin",j[0]+14+" "+(j[1]+5)).style("transform","rotate("+(h.heading+90)+"deg) ").attr("route",h.route).attr("list",f.length?"filtered":"all").attr("route-dir",h.dir).on("click",function(){if(event.stopPropagation(),!d3.select(".vehicleMarker.selected").empty()){var a=d3.select(".vehicleMarker.selected");a.classed("selected",!1).attr("xlink:href","all"===a.attr("list")?"images/bus-icons/bus.png":"images/bus-icons/"+a.attr("route")+".png")}var b=d3.select(this);b.classed("selected",!0).attr("xlink:href","images/bus-icons/bus-blue.png"),k(event,b.attr("route"),b.attr("route-dir"))});e[d]=l}}},j=function(a,b,c){d3.select(".info").remove(),d3.select("body").append("div").attr("class","info").style("top",a.pageY-5+"px").style("left",a.pageX-5+"px").on("mouseout",function(){d3.select(".info").transition().duration(400).style("opacity",0).remove()}).html("<div class='name'>"+b+"</div><div class='dir'>"+c+"</div>")},k=function(a,b,d){h(b,function(b){l();var e=d3.line().x(function(a){return a[0]}).y(function(a){return a[1]}),f=c.append("g").attr("class","routePaths");f.selectAll(".routePath").data(b.pathPoints).enter().append("path").attr("class","routePath").attr("d",e),j(a,b.name,b.directions[d].title);var h=b.directions[d].stops;f.selectAll(".routeStop").data(h).enter().append("circle").attr("class",function(a,b){return b===h.length-1?"routeStop last":"routeStop"}).attr("cx",function(a){return g.mapProjection(a)[0]}).attr("cy",function(a){return g.mapProjection(a)[1]}).attr("r",function(a,b){return b===h.length-1?"6px":"3px"})})},l=function(){c.select(".routePaths").remove(),d3.select(".info").remove()},m=function(a){l(),f=a;for(var b in e)-1===f.indexOf(e[b].attr("route"))&&a.length?e[b].classed("hidden",!0):(e[b].classed("hidden",!1),e[b].attr("list",a.length?"filtered":"all").attr("xlink:href",a.length?"images/bus-icons/"+e[b].attr("route")+".png":"images/bus-icons/bus.png"))},n=function(a){var c={};for(var f in d)if(e[f])if(b[f]){if(d[f].heading!==b[f].heading&&e[f].style("transform","rotate("+(d[f].heading+90)+"deg)"),d[f].coord.toString()!==b[f].coord.toString()){var h=g.mapProjection(d[f].coord);e[f].attr("transform-origin",h[0]+14+" "+(h[1]+5)).transition().duration(1e3).attr("x",h[0]).attr("y",h[1])}}else c[f]=d[f];b=JSON.parse(JSON.stringify(d)),i(c)},o=function(c){if(!a){var e=new Date;a=new Date(e.getTime()+6e4*e.getTimezoneOffset()-288e5).getTime()}d3.xml("http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&a=sf-muni&t="+a).get(function(e,f){var g=[];[].map.call(f.querySelectorAll("vehicle"),function(a){a.getAttribute("dirTag")&&g.push({id:a.getAttribute("id"),speed:a.getAttribute("speedKmHr"),heading:parseInt(a.getAttribute("heading")),dir:a.getAttribute("dirTag").indexOf("_I_")>-1?"I":"O",leadV:parseFloat(a.getAttribute("leadingVehicleId")),route:a.getAttribute("routeTag"),coord:[parseFloat(a.getAttribute("lon")),parseFloat(a.getAttribute("lat"))]})}),g.forEach(function(a,b){d[a.id]=a}),a=[].map.call(f.querySelectorAll("lastTime"),function(a){return{time:a.getAttribute("time")}}),a=parseInt(a[0].time),b||(b=JSON.parse(JSON.stringify(d))),c(d)})};return{renderVehicles:i,queryVehicles:o,updateVehicles:n,updateRouteFilters:m}}(),sftransitApp=angular.module("sftransitApp",[]);sftransitApp.controller("MenuController",function(a,b,c){var d;b.get("data/routes.json").then(function(b){d=b.data,a.routes=b.data}),a.$watch("routeFilter",function(){if(a.routeFilter&&a.routeFilter.length){var b=[];d.forEach(function(c,d){c.title.toLowerCase().indexOf(a.routeFilter.toLowerCase())>-1&&b.push(c)}),b.length||b.push({title:"No routes found",tag:"na"}),a.routes=b}else a.routes=d}),a.routesFiltered={},a.timer=function(){var b=d3.timeFormat("%a, %-e %b %-I:%M:%S %p"),d=new Date;d=new Date(d.getTime()+6e4*d.getTimezoneOffset()-288e5),a.time=b(d),c(a.timer,1e3)},a.timer(),a.refresh=function(){MapRender.queryVehicles(function(a){MapRender.updateVehicles()}),c(a.refresh,1e4)},MapRender.queryVehicles(function(b){MapRender.renderVehicles(b),c(a.refresh,1e4)}),a.filterEvent=function(a){var b=d3.select(a.currentTarget);b.classed("selected",!b.classed("selected"));var c=b.attr("data-id");if("na"!==c){var d={title:c,color:b.attr("data-color")};this.routesFiltered[c]||(this.routesFiltered[c]=d,MapRender.updateRouteFilters(Object.keys(this.routesFiltered)))}},a.removeRoute=function(a){var b=d3.select(a.currentTarget),c=b.attr("data-id");delete this.routesFiltered[c],b.remove(),MapRender.updateRouteFilters(Object.keys(this.routesFiltered))}});